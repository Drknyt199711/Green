<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Green Book | Bet Tracker</title>
    <style>
        :root {
            --primary-color: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #ffffff;
            --text-secondary: #bdbdbd;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
        }

        .light-mode {
            --bg-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #212121;
            --text-secondary: #757575;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            transition: all 0.3s ease;
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .no-data {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .light-mode header {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        h1, h2, h3 {
            font-weight: 500;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--primary-light);
        }

        h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 1rem;
            transition: all 0.2s;
        }

        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding-right: 15px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23bdbdbd"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
        }

        .light-mode input[type="date"] {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="%23757575"><path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z"/></svg>');
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        input, select {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode input, .light-mode select {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: rgba(0, 0, 0, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            cursor: pointer;
        }

        button:active {
            transform: scale(0.98);
        }

        button.secondary {
            width: 20%;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        button.secondary2 {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .light-mode button.secondary {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }

        .light-mode .stat-card {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 1.2rem;
            font-weight: 500;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 10px; /* Default margin-top, adjusted by specific history tab CSS */
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .light-mode th, .light-mode td {
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        th {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .win {
            color: var(--success-color);
        }

        .loss {
            color: var(--danger-color);
        }

        .pending {
            color: var(--warning-color);
        }

        /* Main Tabs - Sticky at top */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0; /* Remove margin-bottom as dropdown will follow */
            position: sticky;
            top: 0;
            background-color: var(--bg-color); /* Ensure background for visibility */
            z-index: 1000;
            /* Ensure it's above other content */
            padding-top: 0;
            /* No extra padding */
        }

        .light-mode .tabs {
            border-bottom-color: rgba(0, 0, 0, 0.1);
            background-color: var(--bg-color);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            line-height: 1.5;
            /* Ensure consistent height for calculations */
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #bankrollDisplay {
            font-size: 1.8rem;
            text-align: center;
            margin: 10px 0;
        }

        /* New Styles for History Tab Controls */
        .history-controls-container {
            position: sticky;
            /* Sticky below tabs */
            top: calc(45px);
            /* Height of .tabs (approx 20px padding + 1.5em line-height + 1px border = ~45px) */
            background-color: var(--card-color);
            /* To cover content below */
            z-index: 998;
            /* Below main tabs, but above table content */
            padding: 15px;
            /* Match .card padding */
            margin: 0 -15px;
            /* Extend to card edges */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease; /* Smooth transition for background on theme toggle */
        }

        .light-mode .history-controls-container {
            background-color: var(--card-color);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .toggle-filters-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            display: block;
            /* Make it block to take full width or easily center */
            width: 100%;
            text-align: center;
        }

        .filters-dropdown-content {
            display: none;
            padding-top: 10px; /* Space below toggle button */
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            /* Smooth dropdown animation */
            overflow: hidden;
            /* Hide content when collapsed */
            max-height: 0;
            /* Initial state for collapsing */
            opacity: 0;
            /* Initial state for fading */
        }

        .filters-dropdown-content.active {
            display: block;
            /* Show when active */
            max-height: 500px;
            /* Arbitrary max height to allow content to show */
            opacity: 1;
            /* Fade in */
        }


        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: space-between;
            align-items: center;
        }

        .filters input,
        .filters select {
            flex: 1;
            min-width: 120px;
        }

        .fixed-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            width: 100%;
            margin-top: 10px;
        }

        .fixed-buttons button {
            flex: 1;
            min-width: 100px;
            margin: 0;
        }

        /* Adjust table margin to prevent content from being hidden behind sticky header */
        #history .table-container {
            /* The table content will start below the sticky controls,
               so no top margin is needed if the card padding is handled.
            If card padding is reset, then table can simply start.
            */
            padding-top: 15px;
            /* Add padding to visually separate from dropdown content */
            padding-bottom: 15px;
            /* Padding for bottom of card */
            overflow-y: auto;
            /* Make table scrollable */
            max-height: calc(100vh - 120px);
            /* Adjust based on actual header/tabs/controls height */
            /* 100vh - (60px + 45px + 100px) = 100vh - 205px.
            Let's use 120px for testing. */
        }

        /* Mobile-specific adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1.1rem;
            }

            button, input, select {
                padding: 10px;
                font-size: 0.9rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 8px 5px;
            }
            .filters {
                flex-direction: column;
            }
            .filters input, .filters select {
                width: 100%;
                min-width: unset;
            }
            .fixed-buttons button {
                width: 100%;
                /* Stack buttons vertically on small screens */
            }
            .history-controls-container {
                top: 45px;
                /* Adjust top for mobile if header size changes */
                padding: 10px;
                /* Smaller padding for mobile */
                margin: 0 -10px;
                /* Adjust margin to card edges */
            }
            #history .table-container {
                 max-height: calc(100vh - 100px);
                 /* Adjusted for smaller mobile header/controls */
                 padding-top: 10px;
                 padding-bottom: 10px;
            }
        }
        /* Styles from calc.txt, scoped to #calculator */
        #calculator {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        #calculator .calculator-container {
            background-color: var(--card-color);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 20px auto;
        }
        #calculator h1 {
            text-align: center;
            color: var(--primary-light);
            margin-bottom: 25px;
        }
        #calculator .input-group {
            margin-bottom: 15px;
        }
        #calculator .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        #calculator .input-group input[type="number"],
        #calculator .input-group select {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid var(--text-secondary);
            border-radius: 4px;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
        }
        #calculator button {
            width: 100%;
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 20px;
        }
        #calculator button:hover {
            background-color: var(--primary-dark);
        }
        #calculator .results {
            margin-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
        }
        #calculator .results h2 {
            color: var(--primary-light);
            text-align: center;
            margin-bottom: 15px;
        }
        #calculator .results p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        #calculator .results p strong {
            color: var(--text-color);
        }
        #calculator .error-message {
            color: var(--danger-color);
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <header class="Bighead">
            <h1><b><b>ðŸ“— Green Book </b></b></h1>
            <button id="themeToggle" class="secondary" aria-label="Toggle dark/light mode">ðŸŒ“</button>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="tracker">Tracker</div>
            <div class="tab" data-tab="stats">Stats</div>
            <div class="tab" data-tab="history">History</div>
            <div class="tab" data-tab="calculator">Calculator</div>
        </div>

        <div id="tracker" class="tab-content active">
            <div class="card">
                <h2>ðŸ’° Bankroll</h2>
                <p id="bankrollDisplay">1000.00 ETB</p>
                <div class="grid">
                    <button id="depositBtn">Deposit</button>
                    <button id="withdrawBtn">Withdraw</button>
                </div>
            </div>

            <div class="card">
                <h2>âž• Add Bet</h2>
                <input type="text" id="sport" placeholder="Sport (e.g., NBA)" required>
                <input type="text" id="event" placeholder="Event (e.g., Lakers vs Warriors)" required>
                <input type="number" id="stake" placeholder="Stake (ETB)" min="0.01" step="0.01" required>
                <input type="number" id="odds" placeholder="Odds (e.g., 1.95)" min="1.01" step="0.01" required>
                <select id="outcome">
                    <option value="pending">Pending</option>
                    <option value="win">Win</option>
                    <option value="loss">Loss</option>
                    <option value="void">Void/Canceled</option>
                </select>
                <button id="addBetBtn">Add Bet</button>
            </div>
        </div>

        <div id="stats" class="tab-content">
            <div class="card">
                <h2>ðŸ“Š Performance</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Win Rate</h3>
                        <p id="winRate">0%</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Profit</h3>
                        <p id="totalProfit">0.00 ETB</p>
                    </div>
                    <div class="stat-card">
                        <h3>ROI</h3>
                        <p id="roi">0%</p>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Stake</h3>
                        <p id="avgStake">0.00 ETB</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="card">
                <h2>ðŸ“‹ Bet History</h2>
                <div class="history-controls-container">
                    <button id="toggleFiltersBtn" class="toggle-filters-button">Toggle Filters / Actions</button>
                    <div id="filtersDropdownContent" class="filters-dropdown-content">
                        <div class="filters">
                            <input type="text" id="searchInput" placeholder="Search event/sport/date...">
                            <input type="date" id="fromDateFilter" aria-label="Filter from date">
                            <input type="date" id="toDateFilter" aria-label="Filter to date">
                            <select id="sportFilter">
                                <option value="all">All Sports</option>
                            </select>
                        </div>
                        <div class="fixed-buttons">
                            <button id="deleteSelectedBtn" class="danger">Delete Selected</button>
                            <button id="importBtn" class="secondary2">Import Bets</button>
                            <button id="exportBtn" class="secondary2">Export as CSV</button>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <table id="betTable" aria-label="Bet history">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllBets"></th>
                                <th>Date</th>
                                <th>Sport</th>
                                <th>Event</th>
                                <th>Stake</th>
                                <th>Odds</th>
                                <th>Result</th>
                                <th>P/L</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="betList"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="calculator" class="tab-content">
            <div class="calculator-container">
                <h1>Advanced Bankroll Growth Calculator</h1>

                <div class="input-group">
                    <label for="initialBankroll">Initial Bankroll ($):</label>
                    <input type="number" id="initialBankroll" value="100" min="50" step="50" required>
                </div>

                <div class="input-group">
                    <label for="oddsCalc">Odds (e.g., 1.3, 1.35, 1.4):</label>
                    <input type="number" id="oddsCalc" value="1.3" step="0.01" min="1.0" required>
                </div>

                <div class="input-group">
                    <label for="winRatePercent">Win Rate (in % - e.g., 90 for 90%):</label>
                    <input type="number" id="winRatePercent" value="90" min="0" max="100" step="0.1" required>
                </div>

                <div class="input-group">
                    <label for="maxBetPerSlip">Maximum Bet per Slip ($):</label>
                    <input type="number" id="maxBetPerSlip" value="1000" min="0.01" step="0.01" required>
                    <small>Set to a very high value if no practical limit is desired.</small>
                </div>

                <div class="input-group">
                    <label for="projectionDays">Project Bankroll For (Days):</label>
                    <input type="number" id="projectionDays" value="365" min="1" required>
                </div>

                <button onclick="calculateGrowth()">Calculate Bankroll Growth</button>

                <div id="errorMessage" class="error-message"></div>

                <div class="results">
                    <h2>Projected Bankroll Growth</h2>
                    <p>End of Week 1: <strong><span id="week1Result"></span></strong></p>
                    <p>End of Month 1: <strong><span id="month1Result"></span></strong></p>
                    <p>End of Projected Days (<span id="projectedDaysLabel"></span> days): <strong><span id="finalProjectionResult"></span></strong></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Data Management
        let bankroll = parseFloat(localStorage.getItem('bankroll')) || 1000;
        let bets = JSON.parse(localStorage.getItem('bets')) || [];
        let profitChart = null; // Chart instance reference

        // DOM Elements
        const bankrollEl = document.getElementById('bankrollDisplay');
        const betListEl = document.getElementById('betList');
        const addBetBtn = document.getElementById('addBetBtn');
        const depositBtn = document.getElementById('depositBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const themeToggle = document.getElementById('themeToggle');
        const searchInput = document.getElementById('searchInput');
        const fromDateFilter = document.getElementById('fromDateFilter');
        const toDateFilter = document.getElementById('toDateFilter');
        const sportFilter = document.getElementById('sportFilter');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const selectAllBetsCheckbox = document.getElementById('selectAllBets');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

        const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
        const filtersDropdownContent = document.getElementById('filtersDropdownContent');


        // Initialize
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.remove('dark-mode');
            document.body.classList.add('light-mode');
        }

        updateUI();

        // Tab Navigation
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                
                if (tab.dataset.tab === 'stats') {
                    updateUI('chart');
                } else if (tab.dataset.tab === 'calculator') {
                    calculateGrowth(); 
                }
                if (filtersDropdownContent.classList.contains('active')) {
                    filtersDropdownContent.classList.remove('active');
                }
            });
        });

        // Toggle Filters Dropdown
        toggleFiltersBtn.addEventListener('click', () => {
            filtersDropdownContent.classList.toggle('active');
        });

        // Core Functions
        function saveData() {
            try {
                localStorage.setItem('bets', JSON.stringify(bets));
                localStorage.setItem('bankroll', bankroll);
            } catch (e) {
                displayMessageBox("Storage failed! Export your data before closing.", "error");
                console.error(e);
            }
        }

        function updateUI(updateType = 'all') {
            if (updateType === 'all' || updateType === 'bankroll') {
                bankrollEl.textContent = bankroll.toFixed(2) + ' ETB';
            }
            if (updateType === 'all' || updateType === 'bets') {
                const filteredBets = getFilteredBets();
                renderBetList(filteredBets);
                updateStats(filteredBets);
                updateSportFilter();
            }
            if (updateType === 'all' || updateType === 'chart') {
                const filteredBets = getFilteredBets();
                renderProfitChart(filteredBets);
            }
        }

        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleString(undefined, options);
        }

        function calculateProfit(bet) {
            if (bet.outcome === 'void') return 0;
            if (bet.outcome === 'win') return (bet.stake * bet.odds) - bet.stake;
            if (bet.outcome === 'loss') return -bet.stake;
            return 0;
        }

        function getFilteredBets() {
            const searchTerm = searchInput.value.toLowerCase();
            const sport = sportFilter.value;
            const fromDateStr = fromDateFilter.value;
            const toDateStr = toDateFilter.value;

            const filteredBets = bets.filter(bet => {
                const betDate = new Date(bet.date);

                const matchesSearch = 
                    bet.sport.toLowerCase().includes(searchTerm) || 
                    bet.event.toLowerCase().includes(searchTerm) ||
                    formatDate(bet.date).toLowerCase().includes(searchTerm);
                
                const matchesSport = sport === 'all' || bet.sport === sport;

                let matchesDateRange = true;
                if (fromDateStr) {
                    const fromDate = new Date(fromDateStr);
                    fromDate.setHours(0, 0, 0, 0);
                    if (betDate < fromDate) {
                        matchesDateRange = false;
                    }
                }
                if (toDateStr && matchesDateRange) {
                    const toDate = new Date(toDateStr);
                    toDate.setHours(23, 59, 59, 999);
                    if (betDate > toDate) {
                        matchesDateRange = false;
                    }
                }
                
                return matchesSearch && matchesSport && matchesDateRange;
            });

            return filteredBets;
        }

        function renderBetList(filteredBets) {
            filteredBets.sort((a, b) => new Date(b.date) - new Date(a.date));
            betListEl.innerHTML = '';

            if (filteredBets.length === 0) {
                betListEl.innerHTML = '<tr><td colspan="9" class="no-data">No bets found matching your criteria.</td></tr>';
                return;
            }

            filteredBets.forEach((bet, index) => {
                const row = document.createElement('tr');
                const originalIndex = bets.findIndex(originalBet => originalBet === bet); 
                row.dataset.originalIndex = originalIndex;

                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'bet-checkbox';
                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);
                
                ['date', 'sport', 'event', 'stake', 'odds', 'outcome'].forEach(field => {
                    const cell = document.createElement('td');
                    if (field === 'date') {
                        cell.textContent = formatDate(bet.date);
                    } else if (field === 'stake') {
                        cell.textContent = bet.stake.toFixed(2) + ' ETB';
                    } else if (field === 'odds') {
                        cell.textContent = bet.odds.toFixed(2);
                    } else if (field === 'outcome') {
                        cell.textContent = bet.outcome;
                        cell.className = bet.outcome;
                    } else {
                        cell.textContent = bet[field];
                    }
                    row.appendChild(cell);
                });

                const profitCell = document.createElement('td');
                const profit = calculateProfit(bet);
                profitCell.textContent = profit.toFixed(2) + ' ETB';
                profitCell.className = profit > 0 ? 'win' : profit < 0 ? 'loss' : '';
                row.appendChild(profitCell);

                const actionsCell = document.createElement('td');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'danger';
                deleteButton.onclick = () => displayConfirmationBox('Are you sure you want to delete this bet?', () => {
                    const betToDelete = bets[originalIndex];
                    if (betToDelete && betToDelete.outcome !== 'pending' && betToDelete.outcome !== 'void') {
                        bankroll -= calculateProfit(betToDelete);
                    }
                    bets.splice(originalIndex, 1);
                    saveData();
                    updateUI('all');
                });
                actionsCell.appendChild(deleteButton);
                row.appendChild(actionsCell);

                betListEl.appendChild(row);
            });
        }

        function updateStats(filteredBets) {
            const settledBets = filteredBets.filter(bet => bet.outcome !== 'pending' && bet.outcome !== 'void');
            if (settledBets.length === 0) {
                document.getElementById('winRate').textContent = '0%';
                document.getElementById('totalProfit').textContent = '0.00 ETB';
                document.getElementById('roi').textContent = '0%';
                document.getElementById('avgStake').textContent = '0.00 ETB';
                return;
            }

            const wins = settledBets.filter(bet => bet.outcome === 'win').length;
            const totalProfit = settledBets.reduce((sum, bet) => sum + calculateProfit(bet), 0);
            const totalStaked = settledBets.reduce((sum, bet) => sum + bet.stake, 0);
            const avgStake = totalStaked / settledBets.length;

            const winRate = (wins / settledBets.length) * 100;
            const roi = (totalProfit / totalStaked) * 100;

            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' ETB';
            document.getElementById('roi').textContent = roi.toFixed(1) + '%';
            document.getElementById('avgStake').textContent = avgStake.toFixed(2) + ' ETB';
        }

        function renderProfitChart(filteredBets) {
            const ctx = document.getElementById('profitChart');
            if (profitChart && typeof profitChart.destroy === 'function') {
                profitChart.destroy();
            }
            
            const settledBets = filteredBets.filter(bet => bet.outcome !== 'pending' && bet.outcome !== 'void');
            if (settledBets.length === 0) {
                const parent = ctx.parentNode;
                const existingNoData = parent.querySelector('.no-data');
                if (!existingNoData) {
                     const noDataMessage = document.createElement('p');
                     noDataMessage.className = 'no-data';
                     noDataMessage.textContent = 'No settled bets to display for chart.';
                     parent.appendChild(noDataMessage);
                }
                ctx.style.display = 'none';
                profitChart = null;
                return;
            }
            ctx.style.display = 'block';
            const existingNoData = ctx.parentNode.querySelector('.no-data');
            if (existingNoData) {
                existingNoData.remove();
            }

            const chartLabels = settledBets.map((_, index) => `Bet ${index + 1}`);
            let cumulativeProfit = 0;
            const profitData = settledBets.map(bet => {
                cumulativeProfit += calculateProfit(bet);
                return cumulativeProfit;
            });
            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Cumulative Profit',
                        data: profitData,
                        borderColor: '#4caf50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateSportFilter() {
            const sports = [...new Set(bets.map(bet => bet.sport))];
            sportFilter.innerHTML = `
                <option value="all">All Sports</option>
                ${sports.map(sport => `<option value="${sport}">${sport}</option>`).join('')}
            `;
        }

        function deleteSelectedBets() {
            const selectedCheckboxes = document.querySelectorAll('.bet-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                displayMessageBox('No bets selected for deletion.', "info");
                return;
            }

            displayConfirmationBox(`Are you sure you want to delete ${selectedCheckboxes.length} selected bets?`, () => {
                const indexesToDelete = Array.from(selectedCheckboxes).map(checkbox => {
                    return parseInt(checkbox.closest('tr').dataset.originalIndex);
                }).sort((a, b) => b - a);

                indexesToDelete.forEach(index => {
                    const betToDelete = bets[index];
                    if (betToDelete && betToDelete.outcome !== 'pending' && betToDelete.outcome !== 'void') {
                        bankroll -= calculateProfit(betToDelete);
                    }
                    bets.splice(index, 1);
                });
                
                saveData();
                updateUI('all');
                selectAllBetsCheckbox.checked = false;
            });
        }

        async function exportBetsToCSV() {
            const headers = "Date,Sport,Event,Stake,Odds,Outcome,Profit\n";
            const csv = bets.map(bet => 
                `"${formatDate(bet.date)}","${bet.sport.replace(/"/g, '""')}","${bet.event.replace(/"/g, '""')}",${bet.stake},${bet.odds},${bet.outcome},${calculateProfit(bet)}`
            ).join('\n');
            const fullCsvContent = headers + csv;

            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: 'the_green_book_bet_history.csv',
                        types: [{
                            description: 'CSV Files',
                            accept: {
                                'text/csv': ['.csv'],
                            },
                        }],
                    });
                    const writableStream = await fileHandle.createWritable();
                    await writableStream.write(fullCsvContent);
                    await writableStream.close();
                    displayMessageBox('Bet history exported successfully!', "success");
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('User aborted the save operation.');
                    } else {
                        console.error('Error saving file:', error);
                        displayMessageBox('Error exporting file. Please try again or use the traditional download method.', "error");
                    }
                }
            } else {
                const blob = new Blob([fullCsvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'the_green_book_bet_history.csv';
                a.click();
                URL.revokeObjectURL(url);
                displayMessageBox('Bet history downloaded successfully!', "success");
            }
        }

        function importBets(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    displayMessageBox('CSV file is empty.', "info");
                    return;
                }

                const importedBets = [];
                const startIndex = lines[0].startsWith('Date,Sport,Event,Stake,Odds,Outcome,Profit') ? 1 : 0;

                for (let i = startIndex; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length >= 6) { 
                        importedBets.push({
                            date: parts[0].replace(/"/g, ''),
                            sport: parts[1].replace(/"/g, ''),
                            event: parts[2].replace(/"/g, ''),
                            stake: parseFloat(parts[3]),
                            odds: parseFloat(parts[4]),
                            outcome: parts[5].replace(/"/g, '')
                        });
                    }
                }

                if (importedBets.length > 0) {
                    bets = [...bets, ...importedBets];
                    saveData();
                    updateUI('all');
                    displayMessageBox(`Successfully imported ${importedBets.length} bets.`, "success");
                } else {
                    displayMessageBox('No valid bets found in the CSV file.', "warning");
                }
            };
            reader.readAsText(file);
        }
        
        function createMessageBox(message, type = "info", onConfirm = null, onCancel = null) {
            const existingBox = document.getElementById('customMessageBox');
            if (existingBox) existingBox.remove();

            const messageBox = document.createElement('div');
            messageBox.id = 'customMessageBox';
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: var(--card-color);
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                max-width: 300px;
                text-align: center;
                color: var(--text-color);
                border: 1px solid rgba(255, 255, 255, 0.1);
            `;

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.marginBottom = '15px';
            messageText.style.color = `var(--${type}-color, var(--text-color))`;
            messageBox.appendChild(messageText);

            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.justifyContent = 'center';
            if (onConfirm) {
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'OK';
                confirmBtn.style.backgroundColor = 'var(--success-color)';
                confirmBtn.style.color = 'white';
                confirmBtn.style.flex = '1';
                confirmBtn.onclick = () => {
                    onConfirm();
                    messageBox.remove();
                };
                buttonContainer.appendChild(confirmBtn);
            }

            if (onCancel) {
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.style.backgroundColor = 'var(--danger-color)';
                cancelBtn.style.color = 'white';
                cancelBtn.style.flex = '1';
                cancelBtn.onclick = () => {
                    onCancel();
                    messageBox.remove();
                };
                buttonContainer.appendChild(cancelBtn);
            } else if (!onConfirm) {
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Close';
                closeBtn.style.backgroundColor = 'var(--primary-color)';
                closeBtn.style.color = 'white';
                closeBtn.style.flex = '1';
                closeBtn.onclick = () => messageBox.remove();
                buttonContainer.appendChild(closeBtn);
            }
            
            messageBox.appendChild(buttonContainer);
            document.body.appendChild(messageBox);
        }

        function displayMessageBox(message, type = "info") {
            createMessageBox(message, type);
        }

        function displayConfirmationBox(message, onConfirmCallback, onCancelCallback = () => {}) {
            createMessageBox(message, "warning", onConfirmCallback, onCancelCallback);
        }

        // Event Listeners
        addBetBtn.addEventListener('click', () => {
            const sport = document.getElementById('sport').value.trim();
            const event = document.getElementById('event').value.trim();
            const stake = parseFloat(document.getElementById('stake').value);
            const odds = parseFloat(document.getElementById('odds').value);
            const outcome = document.getElementById('outcome').value;

            if (sport && event && stake > 0 && odds >= 1.01) {
                if (outcome === 'pending' && bankroll < stake) {
                    displayMessageBox("Not enough funds in your bankroll to place this bet as pending!", "error");
                    return;
                }
                if (outcome === 'loss' && bankroll < stake) {
                    displayMessageBox("Not enough funds in your bankroll to record this loss!", "error");
                    return;
                }
                
                const newBet = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    sport,
                    event,
                    stake,
                    odds,
                    outcome
                };
                bets.push(newBet);
                
                if (newBet.outcome === 'win') {
                    bankroll += calculateProfit(newBet);
                } else if (newBet.outcome === 'loss') {
                    bankroll += calculateProfit(newBet);
                }

                saveData();
                updateUI('all');

                document.getElementById('sport').value = '';
                document.getElementById('event').value = '';
                document.getElementById('stake').value = '';
                document.getElementById('odds').value = '';
                document.getElementById('outcome').value = 'pending';
            } else {
                displayMessageBox('Please fill in all bet details correctly.', "warning");
            }
        });

        depositBtn.addEventListener('click', () => {
            displayInputBox('Enter deposit amount:', (amountStr) => {
                const amount = parseFloat(amountStr);
                if (!isNaN(amount) && amount > 0) {
                    bankroll += amount;
                    saveData();
                    updateUI('bankroll');
                } else {
                    displayMessageBox("Invalid amount!", "error");
                }
            });
        });
        withdrawBtn.addEventListener('click', () => {
            displayInputBox('Enter withdrawal amount:', (amountStr) => {
                const amount = parseFloat(amountStr);
                if (!isNaN(amount) && amount > 0 && bankroll >= amount) {
                    bankroll -= amount;
                    saveData();
                    updateUI('bankroll');
                } else {
                    displayMessageBox("Invalid amount or insufficient funds!", "error");
                }
            });
        });
        function displayInputBox(message, onConfirmCallback) {
            const existingBox = document.getElementById('customInputBox');
            if (existingBox) existingBox.remove();

            const inputBox = document.createElement('div');
            inputBox.id = 'customInputBox';
            inputBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: var(--card-color);
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                z-index: 2000;
                max-width: 300px;
                text-align: center;
                color: var(--text-color);
                border: 1px solid rgba(255, 255, 255, 0.1);
            `;

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.marginBottom = '15px';
            messageBox.appendChild(messageText);
            const inputField = document.createElement('input');
            inputField.type = 'number';
            inputField.placeholder = 'Amount';
            inputField.style.width = '100%';
            inputField.style.marginBottom = '10px';
            inputField.style.padding = '8px';
            inputField.style.borderRadius = '5px';
            inputField.style.border = '1px solid var(--text-secondary)';
            inputField.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
            inputField.style.color = 'var(--text-color)';
            inputBox.appendChild(inputField);
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.gap = '10px';
            buttonContainer.style.justifyContent = 'center';

            const okBtn = document.createElement('button');
            okBtn.textContent = 'OK';
            okBtn.style.backgroundColor = 'var(--primary-color)';
            okBtn.style.color = 'white';
            okBtn.style.flex = '1';
            okBtn.onclick = () => {
                onConfirmCallback(inputField.value);
                inputBox.remove();
            };
            buttonContainer.appendChild(okBtn);

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.backgroundColor = 'var(--danger-color)';
            cancelBtn.style.color = 'white';
            cancelBtn.style.flex = '1';
            cancelBtn.onclick = () => inputBox.remove();
            buttonContainer.appendChild(cancelBtn);
            
            inputBox.appendChild(buttonContainer);
            document.body.appendChild(inputBox);
            inputField.focus();
        }


        selectAllBetsCheckbox.addEventListener('change', (event) => {
            document.querySelectorAll('.bet-checkbox').forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });
        searchInput.addEventListener('input', () => updateUI('bets'));
        fromDateFilter.addEventListener('change', () => updateUI('bets'));
        toDateFilter.addEventListener('change', () => updateUI('bets'));
        sportFilter.addEventListener('change', () => updateUI('bets'));
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        });


        function calculateGrowth() {
            const initialBankroll = parseFloat(document.getElementById('initialBankroll').value);
            const odds = parseFloat(document.getElementById('oddsCalc').value);
            const winRatePercent = parseFloat(document.getElementById('winRatePercent').value);
            const maxBetPerSlip = parseFloat(document.getElementById('maxBetPerSlip').value);
            const projectionDays = parseInt(document.getElementById('projectionDays').value);
            const errorMessageDiv = document.getElementById('errorMessage');
            errorMessageDiv.textContent = '';

            if (isNaN(initialBankroll) || initialBankroll < 50 || initialBankroll % 50 !== 0) {
                errorMessageDiv.textContent = 'Please enter an initial bankroll that is a multiple of 50 (e.g., 100, 150).';
                return;
            }
            if (isNaN(odds) || odds <= 1.0) {
                errorMessageDiv.textContent = 'Please enter valid odds (must be greater than 1.0).';
                return;
            }
            if (isNaN(winRatePercent) || winRatePercent < 0 || winRatePercent > 100) {
                errorMessageDiv.textContent = 'Please enter a win rate between 0 and 100%.';
                return;
            }
            if (isNaN(maxBetPerSlip) || maxBetPerSlip <= 0) {
                errorMessageDiv.textContent = 'Please enter a positive value for maximum bet per slip.';
                return;
            }
            if (isNaN(projectionDays) || projectionDays < 1) {
                errorMessageDiv.textContent = 'Please enter a valid number of projection days (at least 1).';
                return;
            }

            const winRateDecimal = winRatePercent / 100;
            const numSlipsPerRound = 10;
            const betPercentageOfFloorBankroll = 0.20;

            const roundGainFactor = (winRateDecimal * odds) - 1;
            let currentBankroll = initialBankroll;
            const dailyBankrolls = [];

            for (let day = 0; day < projectionDays; day++) {
                for (let roundNum = 0; roundNum < 2; roundNum++) {
                    const floorBankroll = Math.floor(currentBankroll / 50) * 50;
                    let betAmountRoundCalculated = betPercentageOfFloorBankroll * floorBankroll;
                    let betPerSlipCalculated = betAmountRoundCalculated / numSlipsPerRound;
                    let actualBetPerSlip = Math.min(betPerSlipCalculated, maxBetPerSlip);
                    let actualBetAmountRound = actualBetPerSlip * numSlipsPerRound;
                    if (actualBetAmountRound <= 0) {
                         continue;
                    }

                    const roundChange = roundGainFactor * actualBetAmountRound;
                    currentBankroll += roundChange;
                }
                dailyBankrolls.push(currentBankroll);
            }

            document.getElementById('week1Result').textContent = `$${dailyBankrolls[6] !== undefined ? dailyBankrolls[6].toFixed(2) : 'N/A'}`;
            document.getElementById('month1Result').textContent = `$${dailyBankrolls[29] !== undefined ? dailyBankrolls[29].toFixed(2) : 'N/A'}`;

            document.getElementById('projectedDaysLabel').textContent = projectionDays;
            document.getElementById('finalProjectionResult').textContent = `$${dailyBankrolls[projectionDays - 1] !== undefined ? dailyBankrolls[projectionDays - 1].toFixed(2) : 'N/A'}`;
        }
    </script>
</body>
</html>

